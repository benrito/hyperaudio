/*! hyperaudio v0.0.6 ~ (c) 2012-2013 Hyperaudio Inc. <hello@hyperaud.io> (http://hyperaud.io) ~ Built: 26th September 2013 22:44:48 */
var HA=function(a,b){var c=function(a,b){function c(a,c,d){this.options={init:!0,touch:!0,mouse:!0,timeout:500,html:"",draggableClass:""};for(var e in d)this.options[e]=d[e];this.droppable="string"==typeof c?b.querySelector(c):c,this.list=this.droppable.querySelector("ul"),this.list||(this.list=b.createElement("ul"),this.droppable.appendChild(this.list)),this.placeholder=b.createElement("li"),this.placeholder.className="placeholder",this.options.init&&(this.handle="string"==typeof a?b.querySelector(a):a,this.handleClassName=this.handle.className,this.reordering=this.handle.parentNode==this.list,this.options.touch&&this.handle.addEventListener("touchstart",this,!1),this.options.mouse&&this.handle.addEventListener("mousedown",this,!1))}return c.prototype.handleEvent=function(a){switch(a.type){case"mousedown":if(1!==a.which)break;case"touchstart":this.start(a);break;case"touchmove":case"mousemove":this.move(a);break;case"touchend":case"mouseup":this.end(a)}},c.prototype.start=function(a){/INPUT/.test(a.target.tagName)||(a.preventDefault(),this.options.touch&&b.addEventListener("touchend",this,!1),this.options.mouse&&b.addEventListener("mouseup",this,!1),clearTimeout(this.dragTimeout),this.initiated=!1,this.lastTarget=null,this.dragTimeout=setTimeout(this.init.bind(this,this.options.html||this.handle.innerHTML,a),this.options.timeout))},c.prototype.init=function(a,c){this.options.init||(this.options.touch&&b.addEventListener("touchend",this,!1),this.options.mouse&&b.addEventListener("mouseup",this,!1)),this.draggable=b.createElement("div"),this.draggable.className="draggable "+this.options.draggableClass,this.draggableStyle=this.draggable.style,this.draggableStyle.cssText="position:absolute;z-index:1000;pointer-events:none;left:-99999px",this.draggable.innerHTML=a,b.body.appendChild(this.draggable),this.draggableCenterX=Math.round(this.draggable.offsetWidth/2),this.draggableCenterY=Math.round(this.draggable.offsetHeight/2),this.position(c),this.options.touch&&b.addEventListener("touchmove",this,!1),this.options.mouse&&b.addEventListener("mousemove",this,!1),this.initiated=!0,this.reordering&&(this.handle.style.display="none"),this.move(c),this.options.onDragStart&&this.options.onDragStart.call(this)},c.prototype.position=function(a){var b=a.changedTouches?a.changedTouches[0]:a;this.draggableStyle.left=b.pageX-this.draggableCenterX+"px",this.draggableStyle.top=b.pageY-this.draggableCenterY+"px"},c.prototype.move=function(a){a.preventDefault(),a.stopPropagation();var c=a.changedTouches?a.changedTouches[0]:a,d=a.touches?b.elementFromPoint(c.pageX,c.pageY):c.target;if(this.position(a),d!=this.lastTarget&&d!=this.placeholder&&d!=this.list){if(this.lastTarget=d,this.list.querySelector(".placeholder")&&this.list.removeChild(this.placeholder),d==this.droppable)return this.list.appendChild(this.placeholder),void 0;if(/(^|\s)item(\s|$)/.test(d.className))for(var e=this.list.querySelectorAll(".item"),f=0,g=e.length;g>f;f++)if(d==e[f]){this.list.insertBefore(this.placeholder,e[f]);break}}},c.prototype.end=function(a){if(clearTimeout(this.dragTimeout),b.removeEventListener("touchend",this,!1),b.removeEventListener("mouseup",this,!1),this.initiated){b.removeEventListener("touchmove",this,!1),b.removeEventListener("mousemove",this,!1);var c=a.changedTouches?a.changedTouches[0]:a;a.touches?b.elementFromPoint(c.pageX,c.pageY):c.target;var d=this.options.html?this.handle.innerHTML:this.draggable.innerHTML;if(this.draggable.parentNode.removeChild(this.draggable),this.draggable=null,this.reordering&&(this.handle._dragInstance&&(this.handle._dragInstance.destroy(),this.handle._dragInstance=null),this.handle.parentNode.removeChild(this.handle)),this.list.querySelector(".placeholder")){var e=b.createElement("li");e.className=this.handleClassName||"item",e.innerHTML=d,this.list.insertBefore(e,this.placeholder),this.placeholder.parentNode.removeChild(this.placeholder),this.options.onDrop&&this.options.onDrop.call(this,e)}}},c.prototype.destroy=function(){b.removeEventListener("touchstart",this,!1),b.removeEventListener("touchmove",this,!1),b.removeEventListener("touchend",this,!1),b.removeEventListener("mousedown",this,!1),b.removeEventListener("mousemove",this,!1),b.removeEventListener("mouseup",this,!1)},c}(a,b),d=function(a,b){function c(a){var b=(a.innerText||a.textContent).split(" ");a.innerHTML="<a>"+b.join(" </a><a>")+"</a>"}function d(a,b){if(!a)return!1;var c=new RegExp("(^|\\s)"+b+"(\\s|$)");return c.test(a.className)}function e(a,b){if(!d(a,b)){var c=a.className.split(" ");c.push(b),a.className=c.join(" ")}}function f(a,b){if(d(a,b)){var c=new RegExp("(^|\\s)"+b+"(\\s|$)","g");a.className=a.className.replace(c," ")}}function g(a,d){this.element=b.querySelector(a),this.options={addHelpers:!1,touch:!0,mouse:!0,threshold:10};for(var e in d)this.options[e]=d[e];this.options.addHelpers&&c(this.element),this.words=this.element.querySelectorAll("a"),this.wordsCount=this.words.length,this.options.touch&&this.element.addEventListener("touchstart",this,!1),this.options.mouse&&this.element.addEventListener("mousedown",this,!1)}return g.prototype.handleEvent=function(a){switch(a.type){case"mousedown":if(1!==a.which)break;case"touchstart":this.start(a);break;case"touchmove":case"mousemove":this.move(a);break;case"touchend":case"mouseup":this.end(a)}},g.prototype.start=function(a){a.preventDefault(),a.touches?a.touches[0]:a,this.selectStarted=!1,this.startX=a.pageX,this.startY=a.pageY,this.options.mouse&&(this.element.addEventListener("mousemove",this,!1),this.element.addEventListener("mouseup",this,!1)),this.options.touch&&(this.element.addEventListener("touchmove",this,!1),this.element.addEventListener("touchend",this,!1)),d(a.target,"selected")&&(this.dragTimeout=setTimeout(this.dragStart.bind(this,a),500))},g.prototype.selectStart=function(a){var b,c=a.target;if(c!=this.element){if(this.selectStarted=!0,this.currentWord=c,f(this.element.querySelector(".first"),"first"),f(this.element.querySelector(".last"),"last"),this.words[this.startPosition]===c)return b=this.startPosition,this.startPosition=this.endPosition,this.endPosition=b,void 0;if(this.words[this.endPosition]!==c){for(var d=0;d<this.wordsCount;d++)this.words[d]==c&&(this.startPosition=d),f(this.words[d],"selected");this.endPosition=this.startPosition,e(c,"selected")}}},g.prototype.move=function(a){var c,d=a.changedTouches?a.changedTouches[0]:a,g=a.touches?b.elementFromPoint(d.pageX,d.pageY):d.target;if(!(Math.abs(d.pageX-this.startX)<this.options.threshold&&Math.abs(d.pageY-this.startY)<this.options.threshold)){if(clearTimeout(this.dragTimeout),!this.selectStarted)return this.selectStart(a),void 0;if(g!=this.element&&g!=this.currentWord){for(var h=0;h<this.wordsCount;h++)this.words[h]==g&&(c=h),void 0===c&&h>=this.startPosition||void 0!==c&&h<=this.startPosition||c==h?e(this.words[h],"selected"):f(this.words[h],"selected");this.currentWord=g,this.endPosition=c}}},g.prototype.end=function(){if(clearTimeout(this.dragTimeout),this.options.touch&&(this.element.removeEventListener("touchmove",this,!1),this.element.removeEventListener("touchend",this,!1)),this.options.mouse&&(this.element.removeEventListener("mousemove",this,!1),this.element.removeEventListener("mouseup",this,!1)),this.selectStarted){var a=Math.min(this.startPosition,this.endPosition),b=Math.max(this.startPosition,this.endPosition);e(this.words[a],"first"),e(this.words[b],"last")}},g.prototype.clearSelection=function(){f(this.element.querySelector(".first"),"first"),f(this.element.querySelector(".last"),"last"),this.options.touch&&(this.element.removeEventListener("touchmove",this,!1),this.element.removeEventListener("touchend",this,!1)),this.options.mouse&&(this.element.removeEventListener("mousemove",this,!1),this.element.removeEventListener("mouseup",this,!1));for(var a=this.element.querySelectorAll(".selected"),b=0,c=a.length;c>b;b++)f(a[b],"selected")},g.prototype.getSelection=function(){for(var a=this.element.querySelectorAll(".selected"),b="",c=0,d=a.length;d>c;c++)b+=a[c].outerHTML.replace(/ class="[\d\w\s\-]*\s?"/gi," ");return b},g.prototype.dragStart=function(a){a.stopPropagation(),this.options.touch&&(this.element.removeEventListener("touchmove",this,!1),this.element.removeEventListener("touchend",this,!1)),this.options.mouse&&(this.element.removeEventListener("mousemove",this,!1),this.element.removeEventListener("mouseup",this,!1)),a.changedTouches?a.changedTouches[0]:a,this.options.onDragStart&&this.options.onDragStart.call(this,a)},g.prototype.destroy=function(){this.element.removeEventListener("touchstart",this,!1),this.element.removeEventListener("touchmove",this,!1),this.element.removeEventListener("touchend",this,!1),this.element.removeEventListener("mousedown",this,!1),this.element.removeEventListener("mousemove",this,!1),this.element.removeEventListener("mouseup",this,!1)},g}(a,b),e=function(a){return{core:{options:{DEBUG:!0,entity:"core"},event:{load:"ha:load",error:"ha:error"},_trigger:function(b,c){var d=a.extend({options:this.options},c),e=a.Event(b,{ha:d});a(this).trigger(e)},_error:function(a){var b={msg:this.options.entity+" Error : "+a};this._trigger(this.event.error,b)},_debug:function(){var b=this;a.each(this.event,function(c,d){a(b).on(d,function(a){console.log(b.options.entity+' triggered "'+d+'" event : '+a.ha.msg)})})}},register:function(b,c){"string"==typeof b&&("function"==typeof c?(c.prototype=a.extend({},this.core,c.prototype),this[b]=function(a){return new c(a)}):"object"==typeof c&&(c=a.extend({},this.core,c),this[b]=c))},utility:function(a,b){"string"==typeof a&&(this[a]=b)}}}(jQuery),f=function(a,c){function d(b){this.options=a.extend({},this.options,{entity:"PLAYER",target:"#transcript-video",src:"",async:!0},b),this.options.DEBUG&&this._debug(),this.options.target&&this.create()}return d.prototype={create:function(c){var d;c&&(this.options.target=c),d=a(this.options.target),d.length?(this.video=b.createElement("video"),this.video.controls=!0,a(this.options.target).empty().append(this.video),this.options.src&&this.load()):this._error("Target not found : "+this.options.target)},load:function(a){a&&(this.options.src=a),this.video?(this.killPopcorn(),this.video.src=this.options.src,this.initPopcorn()):this._error("Video player not created : "+this.options.target)},initPopcorn:function(){this.killPopcorn(),this.popcorn=c(this.video)},killPopcorn:function(){this.popcorn&&(this.popcorn.destroy(),delete this.popcorn)},play:function(a){this.video.currentTime=a,this.video.play()},currentTime:function(a){this.video.currentTime=a}},d}(jQuery,Popcorn),g=function(a,b){function e(b){this.options=a.extend({},this.options,{entity:"TRANSCRIPT",transcript:"#transcript",stage:"#stage",src:"",video:"",group:"p",word:"a",timeAttr:"data-m",unit:.001,async:!0,player:null},b),this.ready=!1,this.enabled=!1,this.selectable=!1,this.options.DEBUG&&this._debug(),this.options.src&&this.load()}return e.prototype={load:function(b){var c=this,d=a(this.options.transcript);b&&(b.src&&(this.options.src=b.src),b.video&&(this.options.video=b.video)),d.length?d.empty().load(this.options.src,function(a,b,d){"error"===b?c._error(d.status+" "+d.statusText+' : "'+c.options.src+'"'):(c._trigger(c.event.load,{msg:'Loaded "'+c.options.src+'"'}),c.options.async?setTimeout(function(){c.setVideo()},0):c.setVideo())}):this._error("Target not found : "+this.options.transcript)},setVideo:function(a){var b=this;a&&(this.options.video=a),this.options.player?(this.options.player.load(this.options.video),this.options.async?setTimeout(function(){b.parse()},0):this.parse()):this._error("Player not defined")},parse:function(){var c=this.options;this.popcorn=b("#source-video"),c.player&&c.player.popcorn&&(a(c.transcript+" "+c.word).each(function(){c.player.popcorn.transcript({time:a(this).attr(c.timeAttr)*c.unit,futureClass:"transcript-grey",target:this,onNewPara:function(){}})}),a(c.transcript).on("click","a",function(){var b=a(this).attr(c.timeAttr),d=b*c.unit;c.player.currentTime(d)})),this.selectorize()},selectorize:function(){var b=this.options,e=a(b.stage),f=function(a){e.removeClass("dragdrop"),a._dragInstance=new c(a,b.stage,{onDragStart:function(){e.addClass("dragdrop"),a.style.display="none"},onDrop:f})},g=new d(b.transcript,{onDragStart:function(a){e.addClass("dragdrop");var d=new c(null,b.stage,{init:!1,onDrop:function(a){g.clearSelection(),this.destroy(),f(a)}}),h=this.getSelection().replace(/ class="[\d\w\s\-]*\s?"/gi,"");d.init(h,a)}});this.selectable=!0},enable:function(){this.enabled=!0},disable:function(){this.enabled=!1}},e}(jQuery,Popcorn);return e.register("Player",f),e.register("Transcript",g),e.utility("DragDrop",c),e.utility("WordSelect",d),e}(window,document);